<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Indicadores</title>

<style>
body{
  font-family: 'Segoe UI', Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}
h2{text-align:center;color:#2c3e50;}
input,select{padding:10px;margin:8px 5px;border-radius:6px;border:1px solid #ccc;}
.controles{text-align:center;margin-bottom:10px;}
.table-container{overflow:auto;max-height:65vh;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);background:white;}
table{border-collapse:collapse;width:100%;font-size:12px;}
th{background:#34495e;color:white;padding:10px;position:sticky;top:0;z-index:2;}
td{padding:8px;text-align:center;border-bottom:1px solid #eee;}
tr:nth-child(even){background:#f9fbfd;}
tr:hover{background:#e8f4ff;}
.kpi-verde{background:#d4edda;color:#155724;font-weight:bold;}
.kpi-amarillo{background:#fff3cd;color:#856404;font-weight:bold;}
.kpi-rojo{background:#f8d7da;color:#721c24;font-weight:bold;}
#resumenKPI{background:white;padding:12px;border-radius:10px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);font-size:12px;}
</style>
</head>

<body>

<h2>ðŸ“Š Panel de Indicadores</h2>

<div class="controles">
  <input type="text" id="filtro" placeholder="Buscar...">
  <select id="vista">
    <option value="dia">Vista Diaria</option>
    <option value="semana">Vista Semanal</option>
    <option value="mes">Vista Mensual</option>
  </select>
  <select id="mesFiltro">
    <option value="">Todos los meses</option>
  </select>
</div>

<div id="resumenKPI"></div>

<div class="table-container">
<table>
  <thead></thead>
  <tbody></tbody>
</table>
</div>

<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

/* ===== CSV PARSER REAL ===== */
function parseCSV(text){
  const rows = [];
  let row=[], value="", insideQuotes=false;

  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];

    if(c === '"' && insideQuotes && n === '"'){ value+='"'; i++; }
    else if(c === '"'){ insideQuotes=!insideQuotes; }
    else if(c === ',' && !insideQuotes){ row.push(value); value=""; }
    else if((c === '\n' || c === '\r') && !insideQuotes){
      if(value || row.length){ row.push(value); rows.push(row); }
      row=[]; value="";
    } else value+=c;
  }
  if(value || row.length){ row.push(value); rows.push(row); }
  return rows;
}

fetch(url)
.then(r=>r.text())
.then(csv=>{
  const filas=parseCSV(csv);
  const encabezados=filas[0];
  const datos=filas.slice(1);

  const IDX={
    DIA: encabezados.indexOf("DIA"),
    SEMANA: encabezados.indexOf("SEMANA"),
    MES: encabezados.indexOf("MES")
  };

  const thead=document.querySelector("thead");
  const tbody=document.querySelector("tbody");

  thead.innerHTML="<tr>"+encabezados.map(h=>`<th>${h}</th>`).join("")+"</tr>";

  // Meses dinÃ¡micos desde CSV
  const mesSel=document.getElementById("mesFiltro");
  [...new Set(datos.map(f=>f[IDX.MES]))].forEach(m=>{
    if(!m) return;
    const o=document.createElement("option");
    o.value=o.textContent=m;
    mesSel.appendChild(o);
  });

  function reglaPorColumna(h,v){
    if(!v.includes("%")) return "";
    const n=parseFloat(v.replace("%",""));
    if(isNaN(n)) return "";

    const reglas={"% FCR 1dia":90,"%FCR 7dia":90,"% Adher General":80,"% Descto":80,"% Rein.":5,"% Ef. BAF":80,"% Argumentario":23,"% Oferta":80,"% Adh Capl":25,"%adh Oferta 0":20,"%adh Oferta 1":12,"%adh Oferta 2":23,"%adh Oferta 3":55,"% VS Atendidas":90,"% Baja Parc.":4,"% Short Call":5,"% Transf.":10};
    const meta=reglas[h] ?? 85;
    const menos=["% Short Call","% Transf.","% Adh Capl","% Rein.","%adh Oferta 0","% Baja Parc.","% Argumentario","%adh Oferta 1","%adh Oferta 2","%adh Oferta 3"];

    if(menos.includes(h)){
      if(n<=meta) return "kpi-verde";
      if(n<=meta+5) return "kpi-amarillo";
      return "kpi-rojo";
    }
    if(n>=meta) return "kpi-verde";
    if(n>=meta-10) return "kpi-amarillo";
    return "kpi-rojo";
  }

  function render(filtrado){
    tbody.innerHTML="";
    const frag=document.createDocumentFragment();

    filtrado.forEach(f=>{
      const tr=document.createElement("tr");
      f.forEach((c,i)=>{
        const td=document.createElement("td");
        td.textContent=c;
        td.className=reglaPorColumna(encabezados[i],c);
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  function aplicarFiltros(){
    const t=filtro.value.toLowerCase();
    const v=vistaSel.value;
    const m=mesSel.value;

    render(datos.filter(f=>{
      if(m && f[IDX.MES]!==m) return false;
      if(v==="dia" && f[IDX.DIA].includes("Total")) return false;
      if(v==="semana" && !f[IDX.SEMANA].includes("Total Semana")) return false;
      if(v==="mes" && !f[IDX.MES].includes("Total")) return false;
      return f.join(" ").toLowerCase().includes(t);
    }));
  }

  function debounce(fn,d=300){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);};}

  const filtro=document.getElementById("filtro");
  const vistaSel=document.getElementById("vista");

  filtro.addEventListener("keyup",debounce(aplicarFiltros));
  vistaSel.addEventListener("change",aplicarFiltros);
  mesSel.addEventListener("change",aplicarFiltros);

  render(datos);
});
</script>

</body>
</html>
