<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Indicadores</title>

<style>
body{
  font-family: 'Segoe UI', Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}

h2{
  text-align:center;
  color:#2c3e50;
}

input, select{
  padding:10px;
  margin:8px 5px;
  border-radius:6px;
  border:1px solid #ccc;
}

.controles{
  text-align:center;
  margin-bottom:10px;
}

.table-container{
  overflow:auto;
  max-height:65vh;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  background:white;
}

table{
  border-collapse:collapse;
  width:100%;
  font-size:12px;
}

th{
  background:#34495e;
  color:white;
  padding:10px;
  position:sticky;
  top:0;
  z-index:2;
}

td{
  padding:8px;
  text-align:center;
  border-bottom:1px solid #eee;
}

tr:nth-child(even){ background:#f9fbfd; }
tr:hover{ background:#e8f4ff; }

.kpi-verde{ background:#d4edda; color:#155724; font-weight:bold; }
.kpi-amarillo{ background:#fff3cd; color:#856404; font-weight:bold; }
.kpi-rojo{ background:#f8d7da; color:#721c24; font-weight:bold; }

#resumenKPI{
  background:white;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  font-size:12px;
}
</style>
</head>

<body>

<h2>ðŸ“Š Panel de Indicadores</h2>

<div class="controles">
  <input type="text" id="filtro" placeholder="Buscar...">
  <select id="vista">
    <option value="dia">Vista Diaria</option>
    <option value="semana">Vista Semanal</option>
    <option value="mes">Vista Mensual</option>
  </select>
  <select id="mesFiltro">
    <option value="">Todos los meses</option>
  </select>
</div>

<div id="resumenKPI"></div>

<div class="table-container">
<table>
  <thead></thead>
  <tbody></tbody>
</table>
</div>

<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

fetch(url)
.then(res => res.text())
.then(data => {
  const filas = data.trim().split("\n").map(f => f.split(","));
  const encabezados = filas[0];
  const datos = filas.slice(1);

  const thead = document.querySelector("thead");
  const tbody = document.querySelector("tbody");

  thead.innerHTML = "<tr>" + encabezados.map(h => `<th>${h}</th>`).join("") + "</tr>";

  // llenar meses
  const mesesUnicos = [...new Set(datos.map(f => f[encabezados.indexOf("MES")]))];
  const mesSelect = document.getElementById("mesFiltro");
  mesesUnicos.forEach(m=>{
    let op=document.createElement("option");
    op.value=m; op.textContent=m;
    mesSelect.appendChild(op);
  });

function reglaPorColumna(encabezado, valor){
  if(!valor.includes("%")) return "";
  const num = parseFloat(valor.replace("%","").trim());

  const reglas = {
    "% FCR 1dia": 90,
    "%FCR 7dia": 90,
    "% Adher General": 80,
    "% Descto": 80,
    "% Rein.": 5,
    "% Ef. BAF": 80,
    "% Argumentario": 23,
    "% Oferta": 80,
    "% Adh Capl": 25,
    "%adh Oferta 0": 20,
    "%adh Oferta 1": 12,
    "%adh Oferta 2": 23,
    "%adh Oferta 3": 55,
    "% VS Atendidas": 90,
    "% Baja Parc.": 4,
    "% Short Call": 5,
    "% Transf.": 10
  };

  let meta = reglas[encabezado] ?? 85;

  const menosEsMejor = ["% Short Call","% Transf.","% Adh Capl","% Rein.","%adh Oferta 0","% Baja Parc.","% Argumentario","%adh Oferta 1","%adh Oferta 2","%adh Oferta 3"];

  if(menosEsMejor.includes(encabezado)){
    if(num <= meta) return "kpi-verde";
    if(num <= meta + 5) return "kpi-amarillo";
    return "kpi-rojo";
  }

  if(num >= meta) return "kpi-verde";
  if(num >= meta - 10) return "kpi-amarillo";
  return "kpi-rojo";
}

function calcularResumen(filas){
  const resumen={}, cont={};

  filas.forEach(f=>{
    f.forEach((c,i)=>{
      if(c.includes("%")){
        const n=parseFloat(c.replace("%",""));
        if(!isNaN(n)){
          const h=encabezados[i];
          resumen[h]=(resumen[h]||0)+n;
          cont[h]=(cont[h]||0)+1;
        }
      }
    });
  });

  let html="<b>ðŸ“Š Resumen KPI</b><br>";
  for(let k in resumen){
    const prom=(resumen[k]/cont[k]).toFixed(1)+"%";
    const clase=reglaPorColumna(k,prom);
    html+=`<span class="${clase}" style="padding:6px 10px;margin:4px;display:inline-block;border-radius:6px;">
      ${k}: <b>${prom}</b></span>`;
  }
  document.getElementById("resumenKPI").innerHTML=html;
}

function render(filtrado){
  tbody.innerHTML="";
  filtrado.forEach(fila=>{
    let tr="<tr>";
    fila.forEach((c,i)=>{
      tr+=`<td class="${reglaPorColumna(encabezados[i],c)}">${c}</td>`;
    });
    tr+="</tr>";
    tbody.innerHTML+=tr;
  });
  calcularResumen(filtrado);
}
// aplicamos filtros
function aplicarFiltros(){
  const texto = filtro.value.toLowerCase();
  const vista = vistaSel.value;
  const mesElegido = mesSel.value;

  const resultado = datos.filter(f => {

    const colDia = f[encabezados.indexOf("DIA")];
    const colSemana = f[encabezados.indexOf("SEMANA")];
    const colMes = f[encabezados.indexOf("MES")];

    // Filtro por mes elegido
    if(mesElegido && !colMes.includes(mesElegido)) return false;

    // Vista diaria â†’ solo cuando DIA tiene nÃºmero real
    if(vista === "dia"){
      if(colDia.includes("Total")) return false;
    }

    // Vista semanal â†’ cuando SEMANA tiene Total Semana
    if(vista === "semana"){
      if(!colSemana.includes("Total Semana")) return false;
    }

    // Vista mensual â†’ cuando MES tiene Total
    if(vista === "mes"){
      if(!colMes.includes("Total")) return false;
    }

    // Buscador libre
    return f.some(c => c.toLowerCase().includes(texto));
  });

  render(resultado);
}


  

const filtro=document.getElementById("filtro");
const vistaSel=document.getElementById("vista");
const mesSel=document.getElementById("mesFiltro");

filtro.addEventListener("keyup", aplicarFiltros);
vistaSel.addEventListener("change", aplicarFiltros);
mesSel.addEventListener("change", aplicarFiltros);

render(datos);
});
</script>

</body>
</html>
